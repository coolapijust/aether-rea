services:
  # Aether 核心服务端 (Host 直连模式 + 多态伪装挂载)
  # 彻底移除 Caddy 代理层，由 Backend 直接处理 TLS 和 443 端口
  aether-backend:
    image: ghcr.io/coolapijust/aether-realist:${AETHER_IMAGE_TAG:-main}
    container_name: aether-gateway-core
    restart: always
    network_mode: host
    environment:
      - PSK=${PSK}
      - LISTEN_ADDR=:${CADDY_PORT}
      - SSL_CERT_FILE=${CERT_FILE:-/certs/server.crt}
      - SSL_KEY_FILE=${KEY_FILE:-/certs/server.key}
      - DECOY_ROOT=/decoy
      - WINDOW_PROFILE=${WINDOW_PROFILE:-normal}
      - RECORD_PAYLOAD_BYTES=${RECORD_PAYLOAD_BYTES:-16384}
      - PERF_DIAG_ENABLE=${PERF_DIAG_ENABLE:-0}
      - PERF_DIAG_INTERVAL_SEC=${PERF_DIAG_INTERVAL_SEC:-10}
      - QUIC_INITIAL_STREAM_RECV_WINDOW=${QUIC_INITIAL_STREAM_RECV_WINDOW:-}
      - QUIC_INITIAL_CONN_RECV_WINDOW=${QUIC_INITIAL_CONN_RECV_WINDOW:-}
      - QUIC_MAX_STREAM_RECV_WINDOW=${QUIC_MAX_STREAM_RECV_WINDOW:-}
      - QUIC_MAX_CONN_RECV_WINDOW=${QUIC_MAX_CONN_RECV_WINDOW:-}
      - TCP_TO_WT_ADAPTIVE=${TCP_TO_WT_ADAPTIVE:-1}
      - TCP_TO_WT_COALESCE_MS=${TCP_TO_WT_COALESCE_MS:-}
      - TCP_TO_WT_FLUSH_THRESHOLD=${TCP_TO_WT_FLUSH_THRESHOLD:-}
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ./certs:/certs:ro
      - ${DECOY_PATH}:/decoy:ro
    cap_add:
      - NET_ADMIN
