{
	# 全局配置：启用 HTTP/3
	servers {
		protocol {
			experimental_http3
		}
	}
}

{$DOMAIN} {
	# 1. 基础安全头与 H3 宣告
	header {
		# 强制 HSTS (1年)
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		# 防 MIME 嗅探
		X-Content-Type-Options "nosniff"
		# 宣告 H3 支持 (关键)
		Alt-Svc `h3=":443"; ma=2592000`
		# 隐藏集成信息
		-Server
	}

	# 2. 主动防御匹配器 (Active Probe Defense)
	# 逻辑：匹配 API 路径，但如果不满足 (Upgrade: webtransport) 则视为非法探测
	@bad_probe {
		path /v1/api/*
		not header Upgrade webtransport
	}

	# 处理非法探测：返回诱导性 401 错误
	handle @bad_probe {
		header Content-Type application/json
		respond `{"code": 40101, "message": "Invalid Authentication Token"}` 401
	}

	# 3. Aether WebTransport 业务路由
	# 逻辑：仅转发符合协议特征的流量，支持无限流式输出
	handle /v1/api/sync {
		reverse_proxy aether-gateway:8080 {
			header_up Host {host}
			header_up X-Real-IP {remote_host}
			flush_interval -1
		}
	}

	# 4. 默认回落 (Decoy Site)
	# 逻辑：所有非业务请求全部转发至伪装站点容器
	handle {
		reverse_proxy decoy-site:80
	}
}
